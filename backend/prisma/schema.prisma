// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User accounts
model User {
  id                 String            @id @default(uuid())
  email              String            @unique
  passwordHash       String            @map("password_hash")
  name               String
  profilePictureUrl  String?           @map("profile_picture_url")
  createdAt          DateTime          @default(now()) @map("created_at")
  updatedAt          DateTime          @updatedAt @map("updated_at")

  // Relations
  photos             Photo[]
  groups             GroupMembership[]
  createdGroups      Group[]           @relation("GroupCreator")
  albums             Album[]
  faceCollection     FaceCollection?   // Lazy-created on first face index

  @@map("users")
}

// Photo sharing groups
model Group {
  id          String            @id @default(uuid())
  name        String
  description String?
  createdBy   String            @map("created_by")
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")

  // Relations
  creator     User              @relation("GroupCreator", fields: [createdBy], references: [id])
  members     GroupMembership[]
  photos      Photo[]
  albums      Album[]

  @@map("groups")
}

// User-group relationships
model GroupMembership {
  id        String   @id @default(uuid())
  groupId   String   @map("group_id")
  userId    String   @map("user_id")
  role      String   @default("member") // "admin" or "member"
  joinedAt  DateTime @default(now()) @map("joined_at")

  // Relations
  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@map("group_memberships")
}

// Photo metadata
model Photo {
  id            String       @id @default(uuid())
  userId        String       @map("user_id")
  groupId       String?      @map("group_id")
  filename      String
  originalName  String       @map("original_name")
  filePath      String       @map("file_path")
  thumbnailPath String?      @map("thumbnail_path")
  mimeType      String       @map("mime_type")
  fileSize      Int          @map("file_size")
  width         Int?
  height        Int?
  uploadedAt    DateTime     @default(now()) @map("uploaded_at")
  takenAt       DateTime?    @map("taken_at")

  // Relations
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  group         Group?       @relation(fields: [groupId], references: [id], onDelete: SetNull)
  aiTags        AiTag[]
  albums        AlbumPhoto[]
  faces         Face[]       // Detected faces in this photo

  @@index([userId])
  @@index([groupId])
  @@index([uploadedAt])
  @@map("photos")
}

// AI-generated labels
model AiTag {
  id         String   @id @default(uuid())
  photoId    String   @map("photo_id")
  tag        String
  confidence Float
  category   String   // "object", "scene", "activity", "color", "text"
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  photo      Photo    @relation(fields: [photoId], references: [id], onDelete: Cascade)

  @@index([photoId])
  @@index([tag])
  @@index([category])
  @@map("ai_tags")
}

// Photo collections
model Album {
  id                  String              @id @default(uuid())
  name                String
  description         String?
  userId              String?             @map("user_id")
  groupId             String?             @map("group_id")
  isAutoGenerated     Boolean             @default(false) @map("is_auto_generated")
  generationCriteria  String?             @map("generation_criteria") // JSON string for auto-generated albums
  coverPhotoId        String?             @map("cover_photo_id")
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")

  // Relations
  user                User?               @relation(fields: [userId], references: [id], onDelete: Cascade)
  group               Group?              @relation(fields: [groupId], references: [id], onDelete: Cascade)
  photos              AlbumPhoto[]
  shareLinks          ShareLink[]

  @@index([userId])
  @@index([groupId])
  @@map("albums")
}

// Many-to-many album-photo relationship
model AlbumPhoto {
  id        String   @id @default(uuid())
  albumId   String   @map("album_id")
  photoId   String   @map("photo_id")
  addedAt   DateTime @default(now()) @map("added_at")
  order     Int      @default(0)

  // Relations
  album     Album    @relation(fields: [albumId], references: [id], onDelete: Cascade)
  photo     Photo    @relation(fields: [photoId], references: [id], onDelete: Cascade)

  @@unique([albumId, photoId])
  @@map("album_photos")
}

// Public album sharing
model ShareLink {
  id        String    @id @default(uuid())
  albumId   String    @map("album_id")
  token     String    @unique
  expiresAt DateTime? @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")

  // Relations
  album     Album     @relation(fields: [albumId], references: [id], onDelete: Cascade)

  @@index([token])
  @@map("share_links")
}

// ============================================
// AWS Rekognition Face Collection Models
// ============================================

// Face collection per user (personal photos) - created lazily on first face index
model FaceCollection {
  id              String   @id @default(uuid())
  userId          String   @unique @map("user_id")
  awsCollectionId String   @unique @map("aws_collection_id")
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  persons         Person[]

  @@map("face_collections")
}


// Known person in a user's face collection
model Person {
  id           String         @id @default(uuid())
  name         String?        // User-assigned name (e.g., "Mom", "John")
  collectionId String         @map("collection_id") // Required - belongs to user's collection
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")

  // Relations
  collection   FaceCollection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  faces        Face[]

  @@index([collectionId])
  @@map("persons")
}

// Individual face detected in a photo
model Face {
  id          String   @id @default(uuid())
  photoId     String   @map("photo_id")
  personId    String?  @map("person_id")
  awsFaceId   String?  @unique @map("aws_face_id") // AWS-returned face ID after indexing
  boundingBox Json?    @map("bounding_box")        // { left, top, width, height } as percentages
  confidence  Float    @default(0)                 // Detection confidence (0-100)
  indexed     Boolean  @default(false)             // True if indexed in AWS collection
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  photo       Photo    @relation(fields: [photoId], references: [id], onDelete: Cascade)
  person      Person?  @relation(fields: [personId], references: [id], onDelete: SetNull)

  @@index([photoId])
  @@index([personId])
  @@index([awsFaceId])
  @@map("faces")
}
